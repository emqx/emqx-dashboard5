<template>
  <el-table class="object-array-editor key-and-value-editor shadow-none" ref="TableCom" :data="arr">
    <el-table-column v-for="(value, key) in properties" :key="key">
      <template #header>
        {{ value.label }}
        <InfoTooltip>
          <template #content>
            <MarkdownContent :content="value.description" />
          </template>
        </InfoTooltip>
      </template>
      <template #default="{ $index }">
        <template v-if="arr[$index] !== undefined">
          <SchemaFormItem
            v-model="arr[$index][key]"
            :type="(value.type as any)"
            :symbols="value.symbols"
          />
        </template>
      </template>
    </el-table-column>
    <el-table-column width="100px">
      <template #header>
        <a href="javascript:;" @click="addItem">
          {{ $t('Base.add') }}
        </a>
      </template>
      <template #default="{ $index }">
        <a href="javascript:;" @click="deleteItem($index)">
          {{ $t('Base.delete') }}
        </a>
      </template>
    </el-table-column>
  </el-table>
</template>

<script setup lang="ts">
import MarkdownContent from '@/components/MarkdownContent.vue'
import useSchemaRecord from '@/hooks/Schema/useSchemaRecord'
import { Properties } from '@/types/schemaForm'
import { cloneDeep, get, isFunction } from 'lodash'
import { PropType, computed, defineEmits, defineProps, nextTick, onMounted, ref } from 'vue'
import InfoTooltip from './InfoTooltip.vue'
import SchemaFormItem from './SchemaFormItem'

const props = defineProps({
  modelValue: {
    type: Array as PropType<Array<Record<string, any>>>,
    default: () => [],
  },
  properties: {
    type: Object as PropType<Properties>,
    default: () => ({}),
  },
  propKey: {
    type: String,
    required: true,
  },
})
const emit = defineEmits(['update:modelValue'])

const arr = computed({
  get() {
    return props.modelValue
  },
  set(val) {
    emit('update:modelValue', val)
  },
})

const TableCom = ref()

const { initRecordByComponents } = useSchemaRecord()

const addItem = () => {
  const objData = get(initRecordByComponents(props.properties), props.propKey)
  const defaultValue = cloneDeep(objData)
  arr.value = [...arr.value, defaultValue]
}

const deleteItem = (index: number) => {
  arr.value = [...arr.value.slice(0, index), ...arr.value.slice(index + 1)]
}

onMounted(async () => {
  await nextTick()
  if (isFunction(TableCom.value?.doLayout)) {
    TableCom.value.doLayout()
  }
})
</script>

<style lang="scss">
.object-array-editor {
  width: 100%;
}
</style>
