<template>
  <el-form-item class="custom-configs" :label="tl('customConfig')">
    <p class="desc-tips">{{ tl('customConfigDescription') }}</p>
    <el-input
      type="textarea"
      v-model="rawListener"
      :rows="12"
      :placeholder="defaultPlaceHolder"
      @blur="resetRawData"
      @focus="handleFocus"
    />
    <p class="error-msg" v-if="errorMsg !== ''">{{ errorMsg }}</p>
  </el-form-item>
</template>

<script lang="ts" setup>
import { PropType, defineEmits, defineProps, ref, watch, defineExpose } from 'vue'
import useI18nTl from '@/hooks/useI18nTl'
import { Listener } from '@/types/listener'
import { unexposedConfigs } from '@/common/constants'
import useListenerUtils from '@/hooks/Config/useListenerUtils'

const { tl } = useI18nTl('Gateway')

const props = defineProps({
  modelValue: {
    type: Object as PropType<Listener>,
    required: true,
  },
  type: {
    type: String as PropType<'ssl' | 'tcp' | 'ws' | 'wss'>,
    required: true,
  },
})

const emits = defineEmits(['update:modelValue'])

const { objectToString, stringToObject } = useListenerUtils()

const errorMsg = ref('')

const rawListener = ref(objectToString(props.modelValue))

watch(
  () => props.type,
  (val) => {
    setDefaultPlaceHolder(val)
  },
)

watch(
  () => props.modelValue,
  (val) => {
    rawListener.value = objectToString(val)
  },
)

const defaultPlaceHolder = ref('')

function setDefaultPlaceHolder(type: 'ssl' | 'tcp' | 'ws' | 'wss') {
  defaultPlaceHolder.value = objectToString(unexposedConfigs[type])
}
setDefaultPlaceHolder(props.type)

async function resetRawData() {
  try {
    const parsed = await stringToObject(rawListener.value)
    emits('update:modelValue', parsed)
  } catch (error) {
    const err = error as Error
    errorMsg.value = err.toString()
    // ElMessage.error(err.toString())
  }
}

function handleFocus() {
  errorMsg.value = ''
}

defineExpose({
  rawListener,
})
</script>

<style lang="scss">
.custom-configs {
  p.desc-tips {
    margin-top: 0;
  }
  p.error-msg {
    color: #eb4e3d;
    margin: 0;
    padding: 0;
  }
}
</style>
