<template>
  <div class="sys-topics">
    <div class="sys-tip">{{ tl('sysTopicsDesc') }}</div>
    <div class="no-tab-wrapper">
      <el-form ref="retainerForm" :rules="rules" :model="sysTopics" label-position="top">
        <el-row :gutter="30">
          <el-col :span="8">
            <el-form-item :label="tl('messagePublishInterval')" prop="sys_msg_interval">
              <InputWithUnit v-model="sysTopics.sys_msg_interval" v-bind="timeInputProps" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item :label="tl('heartbeatInterval')" prop="sys_heartbeat_interval">
              <InputWithUnit v-model="sysTopics.sys_heartbeat_interval" v-bind="timeInputProps" />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="30">
          <el-col :span="8">
            <el-form-item :label="tl('clientConnected')" prop="sys_event_messages.client_connected">
              <BooleanSelect
                v-model="sysTopics.sys_event_messages.client_connected"
                v-bind="booleanSelectProps"
              />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item
              :label="tl('clientDisconnected')"
              prop="sys_event_messages.client_disconnected"
            >
              <BooleanSelect
                v-model="sysTopics.sys_event_messages.client_disconnected"
                v-bind="booleanSelectProps"
              />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row :gutter="30">
          <el-col :span="8">
            <el-form-item
              :label="tl('clientSubscribed')"
              prop="sys_event_messages.client_subscribed"
            >
              <BooleanSelect
                v-model="sysTopics.sys_event_messages.client_subscribed"
                v-bind="booleanSelectProps"
              />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item
              :label="tl('clientUnsubscribed')"
              prop="sys_event_messages.client_unsubscribed"
            >
              <BooleanSelect
                v-model="sysTopics.sys_event_messages.client_unsubscribed"
                v-bind="booleanSelectProps"
              />
            </el-form-item>
          </el-col>
        </el-row>
        <el-row>
          <el-button type="primary" @click="updateConfigData()">
            {{ $t('Base.save') }}
          </el-button>
        </el-row>
      </el-form>
    </div>
  </div>
</template>

<script lang="ts">
import { defineComponent } from 'vue'

export default defineComponent({
  name: 'sysTopics',
})
</script>

<script setup lang="ts">
import { ref, Ref } from 'vue'
import useI18nTl from '@/hooks/useI18nTl'
import BooleanSelect from '@/components/BooleanSelect.vue'
import InputWithUnit from '@/components/InputWithUnit.vue'
import { SysTopics } from '@/types/advanced'
import { getSystemTopicsConfig, updateSystemTopicConfig } from '@/api/advanced'
import { ElMessage } from 'element-plus'
import useDataNotSaveConfirm, { useCheckDataChanged } from '@/hooks/useDataNotSaveConfirm'

const { t, tl } = useI18nTl('Advanced')
const timeInputProps = {
  units: ['s', 'm'],
  defaultUnit: 's',
}
const booleanSelectProps = {
  trueLabel: t('Base.enabled'),
  falseLabel: t('Base.disabled'),
}

const rules = {}
const sysTopics: Ref<SysTopics> = ref({
  sys_event_messages: {},
} as SysTopics)

const { setRawData, checkDataIsChanged } = useCheckDataChanged(sysTopics)
useDataNotSaveConfirm(checkDataIsChanged)

const getConfig = async () => {
  try {
    sysTopics.value = await getSystemTopicsConfig()
    setRawData(sysTopics.value)
  } catch (error) {
    //
  }
}

const updateConfigData = async () => {
  await updateSystemTopicConfig(sysTopics.value)
  ElMessage.success(t('Base.updateSuccess'))
  getConfig()
}

getConfig()
</script>

<style lang="scss">
.sys-topics {
  .sys-tip {
    margin-bottom: 24px;
  }
}
</style>
